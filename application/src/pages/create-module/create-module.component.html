<!--
  File: src/pages/create-module/create-module.component.html
  Project: fireCNC
  Author: Mark Dyer
  Location: Blenheim, New Zealand
  Contact: intelliservenz@gmail.com

  Description:
  Template for the Create Module page. Renders a form for building a new
  module configuration file.
-->
<main class="flex-grow">
  <form [formGroup]="moduleForm" (ngSubmit)="onSave()" class="space-y-6">
    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6 shadow-lg">
      <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold text-gray-200 flex items-center">
          <i class="fa-solid fa-file-circle-plus mr-3 text-orange-400"></i>
          Create a New Module
        </h2>
      </div>

      <!-- Module Details Section -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div>
            <label for="moduleName" class="block mb-2 text-sm font-medium text-gray-300">Module Name</label>
            <input type="text" id="moduleName" formControlName="moduleName"
                   class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
          </div>
          <div>
            <label for="version" class="block mb-2 text-sm font-medium text-gray-300">Version (e.g., 1.0.0)</label>
            <input type="text" id="version" formControlName="version"
                   class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
          </div>
          <div>
            <label for="author" class="block mb-2 text-sm font-medium text-gray-300">Author</label>
            <input type="text" id="author" formControlName="author"
                   class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
          </div>
          <div>
            <label for="function" class="block mb-2 text-sm font-medium text-gray-300">Device Function</label>
            <select id="function" formControlName="function"
                    class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
              @for (func of deviceFunctions; track func) {
                <option [value]="func">{{ func }}</option>
              }
            </select>
          </div>
        </div>
        <div class="space-y-4">
           <div>
            <label for="protocol" class="block mb-2 text-sm font-medium text-gray-300">Protocol</label>
            <select id="protocol" formControlName="protocol"
                    class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
              @for (proto of protocols(); track proto) {
                <option [value]="proto">{{ proto }}</option>
              }
            </select>
          </div>
          <div>
            <label for="infoUrl" class="block mb-2 text-sm font-medium text-gray-300">Information URL</label>
            <input type="url" id="infoUrl" formControlName="infoUrl" placeholder="https://example.com/product"
                   class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
          </div>
          <div>
            <label for="imageUrl" class="block mb-2 text-sm font-medium text-gray-300">Product Image URL</label>
            <input type="url" id="imageUrl" formControlName="imageUrl" placeholder="https://example.com/image.jpg"
                   class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
          </div>
          <div>
            <label for="description" class="block mb-2 text-sm font-medium text-gray-300">Description</label>
            <textarea id="description" formControlName="description" rows="3"
                      class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5"></textarea>
          </div>
          @if(moduleForm.get('function')?.value !== 'MPG') {
            <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
              <label for="displayOnStatusPage" class="font-semibold text-gray-300">Display on Status Page</label>
              <button type="button" id="displayOnStatusPage" (click)="moduleForm.get('displayOnStatusPage')?.setValue(!moduleForm.get('displayOnStatusPage')?.value); moduleForm.markAsDirty()"
                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-800"
                [class]="moduleForm.get('displayOnStatusPage')?.value ? 'bg-orange-500' : 'bg-gray-600'">
                <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                  [class]="moduleForm.get('displayOnStatusPage')?.value ? 'translate-x-5' : 'translate-x-0'">
                </span>
              </button>
            </div>
          }
          <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
            <label for="displayOnDashboard" class="font-semibold text-gray-300">Display on Dashboard</label>
            <button type="button" id="displayOnDashboard" (click)="moduleForm.get('displayOnDashboard')?.setValue(!moduleForm.get('displayOnDashboard')?.value); moduleForm.markAsDirty()"
              class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-800"
              [class]="moduleForm.get('displayOnDashboard')?.value ? 'bg-orange-500' : 'bg-gray-600'">
              <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                [class]="moduleForm.get('displayOnDashboard')?.value ? 'translate-x-5' : 'translate-x-0'">
              </span>
            </button>
          </div>
        </div>
      </div>

      <!-- Ports Section -->
      @if (moduleForm.get('function')?.value !== 'MPG') {
        <div class="mt-6 pt-6 border-t border-gray-700">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-300">Ports</h3>
            @if (moduleForm.get('function')?.value === 'IO' || moduleForm.get('function')?.value === 'Relay') {
              <button type="button" (click)="addPort()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 text-sm">
                <i class="fa-solid fa-plus mr-2"></i>
                Add Port
              </button>
            }
          </div>
          <div formArrayName="ports" class="space-y-3">
            @for (item of sortedPorts; track item.originalIndex) {
              <div [formGroupName]="item.originalIndex" class="p-4 bg-gray-900/50 rounded-lg border border-gray-600">
                @switch (moduleForm.get('function')?.value) {
                  @case ('IO') {
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
                      <input type="text" formControlName="name" placeholder="Port Name" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                      <select formControlName="type" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                        <option value="input">Input</option>
                        <option value="output">Output</option>
                      </select>
                      <select formControlName="signal" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                        <option value="digital">Digital</option>
                        <option value="analog">Analog</option>
                      </select>
                      <div class="flex items-center justify-end">
                        <button type="button" (click)="removePort(item.originalIndex)" class="text-gray-500 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button>
                      </div>
                    </div>
                    @if (item.control.get('type')?.value === 'input') {
                      <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-center">
                        <select formControlName="inputType" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                          @for (type of inputTypes; track type) { <option [value]="type">{{ type }}</option> }
                        </select>
                        @if (item.control.get('inputType')?.value === 'CT Clamp') {
                          <input type="number" formControlName="ctClampCurrent" placeholder="CT Clamp Current" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                          <input type="number" formControlName="ctClampVoltage" placeholder="CT Clamp Voltage" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                        }
                        @if (moduleForm.get('protocol')?.value === 'MODBUS RTU') {
                          <input type="number" formControlName="registerId" placeholder="Register ID" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                        }
                      </div>
                    }
                  }
                  @case ('Relay') {
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                      <label class="flex items-center space-x-2 text-sm font-medium text-gray-300 p-2.5 bg-gray-700 rounded-lg h-full">
                        <input type="checkbox" formControlName="enabled" class="form-checkbox h-5 w-5 rounded bg-gray-600 border-gray-500 text-orange-500 focus:ring-orange-500/50">
                        <span>Enabled</span>
                      </label>
                      <div>
                          <label [for]="'portRef' + item.originalIndex" class="block mb-1 text-xs font-medium text-gray-400">Port Reference</label>
                          <input [id]="'portRef' + item.originalIndex" type="number" formControlName="portReference" placeholder="e.g. 1" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                      </div>
                      <div>
                          <label [for]="'portName' + item.originalIndex" class="block mb-1 text-xs font-medium text-gray-400">Port Name</label>
                          <input [id]="'portName' + item.originalIndex" type="text" formControlName="name" placeholder="Port Name" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                      </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-700 space-y-4">
                      @if (moduleForm.get('protocol')?.value === 'MODBUS RTU') {
                        <div class="p-3 bg-gray-800 rounded-lg">
                          <h4 class="text-sm font-semibold text-gray-400 mb-2">MODBUS RTU Settings</h4>
                          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                              <input type="number" formControlName="registerId" placeholder="Register ID" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                              <input type="number" formControlName="onValue" placeholder="ON Value" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                              <input type="number" formControlName="offValue" placeholder="OFF Value" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                          </div>
                        </div>
                      }
                      <div class="grid grid-cols-1 items-center gap-4">
                        <div>
                          <label [for]="'oid' + item.originalIndex" class="block mb-1 text-xs font-medium text-gray-400">SNMP OID (Optional)</label>
                          <input [id]="'oid' + item.originalIndex" type="text" formControlName="oid" placeholder="e.g., 1.3.6.1.4.1..." class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg block w-full p-2.5">
                        </div>
                      </div>
                    </div>
                    <div class="text-right mt-2 -mb-2">
                      <button type="button" (click)="removePort(item.originalIndex)" class="text-gray-500 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                  }
                }
              </div>
            }
            @if (ports.controls.length === 0 && (moduleForm.get('function')?.value === 'IO' || moduleForm.get('function')?.value === 'Relay')) {
              <p class="text-center text-gray-500 py-4">No ports added yet.</p>
            }
          </div>
        </div>
      } @else {
        <!-- Axis Configuration Section for MPG -->
        <div class="mt-6 pt-6 border-t border-gray-700">
          <h3 class="text-lg font-bold text-gray-300 mb-4">Axis Configuration</h3>
          <div formArrayName="ports" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @for (control of ports.controls; track $index) {
              <div [formGroupName]="$index" class="p-3 bg-gray-900/50 rounded-lg border border-gray-600 flex items-center justify-between gap-4">
                <input type="text" formControlName="alias" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block w-full p-2.5">
                <button type="button" (click)="control.get('enabled')?.setValue(!control.get('enabled')?.value); moduleForm.markAsDirty()"
                  class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-gray-900"
                  [class]="control.get('enabled')?.value ? 'bg-orange-500' : 'bg-gray-600'">
                  <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                    [class]="control.get('enabled')?.value ? 'translate-x-5' : 'translate-x-0'">
                  </span>
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-4">
      <button type="button" (click)="onCancel()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-200">
        Cancel
      </button>
      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-200 shadow-md">
        Save Module
      </button>
    </div>
  </form>
</main>